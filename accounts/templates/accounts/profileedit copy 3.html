<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>프로필 수정</title>
</head>
<body>
    <div id="profile-edit-container">
        <h1>프로필 수정</h1>

        <form id="profile-edit-form">
            <div>
                <label for="username">Username</label>
                <input type="text" name="username" id="username" placeholder="Username" value="{{ profile_data.username }}">
            </div>
            <div>
                <label for="email">Email</label>
                <input type="email" name="email" id="email" placeholder="Email" value="{{ profile_data.email }}">
            </div>
            <div>
                <label for="profile_image">Profile Image</label>
                <input type="file" name="profile_image" id="profile_image">
            </div>
            <div id="result"></div>  <!-- Content-Type 출력 -->
            <div id="cookie-result">여기에 쿠키 값이 표시됩니다.</div>  <!-- 쿠키 값 출력 -->

            <button type="submit">프로필 수정</button>
        </form>
    </div>

    <script>
        // 쿠키에서 특정 값 가져오는 함수
        function getCookie(name) {
            const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
            return match ? match[2] : null;
        }

        // 쿠키 값 출력
        const cookieValue = getCookie('yourCookieName');  // 쿠키 이름을 실제 사용하려는 값으로 바꾸세요.
        const cookieResultDiv = document.getElementById('cookie-result');
        cookieResultDiv.textContent = `쿠키 값: ${cookieValue}`;  // 쿠키 값 표시
        console.log('Cookie Value:', cookieValue);

        // 프로필 수정 폼 제출 처리
        const form = document.getElementById('profile-edit-form');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // FormData 생성
            const formData = new FormData(form);
            
            // 쿠키에서 access_token 가져오기
            const accessToken = getCookie('access_token'); 

            if (!accessToken) {
                alert('로그인이 필요합니다!');
                return;
            }

            try {
                // API 호출 시 Authorization 헤더에 토큰 포함
                const response = await fetch('/accounts/profileedit/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                    },
                    body: formData
                });

                // 응답의 Content-Type 확인
                const contentType = response.headers.get("Content-Type");

                // HTML 페이지에 Content-Type 표시
                const resultDiv = document.getElementById('result');
                resultDiv.textContent = `Content-Type: ${contentType}`;  // Content-Type 표시
                console.log(`Content-Type: ${contentType}`);

                if (contentType && contentType.includes("text/html")) {
                    if (response.ok) {
                        const data = await response.json();
                        alert(data.message);  // 응답 메시지 출력

                        // 프로필 수정 완료 후 profile.html로 이동
                        window.location.href = '/profile.html';
                    } else {
                        const errorData = await response.json();
                        console.error('에러 발생:', errorData);
                    }
                } else if (contentType && contentType.includes("application/json")) {
                    // HTML 응답 처리 (예: 오류 페이지 등)
                    const errorText = await response.text();
                    console.error("서버 오류: HTML 응답이 반환되었습니다. 오류 페이지 내용:", errorText);
                    alert("서버 오류가 발생했습니다. 나중에 다시 시도해주세요.");
                }

            } catch (error) {
                console.error('서버와의 통신 오류:', error);
                alert("서버와의 통신에 문제가 발생했습니다.");
            }
        });
    </script>
</body>
</html>
